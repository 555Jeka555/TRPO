**Дата:** 2025

**Статус:** Принято

**Контекст:**

Разработка высоконагруженной фриланс-биржи требует выбора технологии, способной обрабатывать тысячи одновременных пользователей при обеспечении доступности и устойчивости к разделению (AP в CAP-теореме).

**Рассмотренные варианты:**

1. **Фокус на ручном тестировании:** Не подходит из-за медленной скорости обратной связи и высокой стоимости в долгосрочной перспективе, особенно при частых деплоях множества сервисов.
2. **Фокус только на unit-тестах:** Недостаточен, так как не проверяет взаимодействие между сервисами, контракты API и поведение системы в целом.
3. **Классическая пирамида тестирования (с дополнениями):** Многоуровневая стратегия, сочетающая скорость изолированных тестов и надежность тестов, проверяющих интеграцию.

**Решение:**

Принята адаптированная **Пирамида тестирования для микросервисов**, состоящая из следующих уровней (снизу вверх):

1. **Интеграционные тесты (Основа пирамиды):** Проверка взаимодействия сервиса с внешними зависимостями (БД, кэш, другие сервисы) в рамках одного модуля/контекста.
2. **Unit-тесты (Широкий средний слой):** Быстрые изолированные тесты бизнес-логики и сложных алгоритмов внутри одного сервиса.
3. **Контрактные тесты (Ключевой элемент для микросервисов):** Гарантия, что потребители и поставщики API понимают друг друга, предотвращая "поломку" API при изменениях.
4. **Тесты компонента/Сервиса (Изолированная проверка функциональности):** Запуск одного сервиса в полной изоляции с подставленными (test doubles) зависимостями для проверки его сквозного поведения.
5. **Сквозные (E2E) тесты (Вершина пирамиды):** Минимальное количество тестов, проверяющих критически важные бизнес-сценарии в среде, максимально приближенной к продакшену.

**Обоснование:**

- **Скорость и стабильность:** Пирамида минимизирует количество медленных и хрупких E2E-тестов, делая акцент на быстрых и надежных тестах нижних уровней. Это дает быструю обратную связь разработчикам.
- **Раннее обнаружение дефектов:** Проблемы с бизнес-логикой и интеграцией с БД обнаруживаются на уровне Unit и Интеграционных тестов, а не на поздних стадиях.
- **Независимость команд:** Контрактные тесты позволяют командам, разрабатывающим сервисы-потребители и сервисы-поставщики, работать независимо, будучи уверенными в совместимости API.
- **Соответствие архитектуре:** Стратегия напрямую решает вызовы микросервисов: проверка изолированной функциональности (Component Tests), межсервисных контрактов (Contract Tests) и общей работоспособности (E2E).
- **Экономическая эффективность:** Автоматизация снижает стоимость регрессионного тестирования и ускоряет выход на рынок.

**Последствия:**

- **Технический стек:** Для каждого сервиса использовать предпочтительный для его команды фреймворк для Unit/Integration тестов. Внедрить Pact или Spring Cloud Contract для контрактного тестирования. Использовать WireMock для HTTP, Testcontainers для БД. Для E2E тестирования использовать Playwright или Cypress.
- **Процессы CI/CD:** Каждый коммит запускает Unit, Интеграционные и Контрактные тесты. Компонентные тесты запускаются при сборке сервиса. E2E тесты запускаются на стейджинг-среде перед деплоем в прод.
- **Разделение ответственности:** Каждая команда отвечает за тестирование своего сервиса, включая написание контрактов и компонентных тестов.
- **Инфраструктура тестирования:** Внедрить Kubernetes и Helm для развертывания изолированных тестовых сред по требованию.
- **Мониторинг качества:** Инструменты мониторинга и логирования должны быть интегрированы с процессом тестирования для выявления проблем, которые не были пойманы автотестами.
- **Обучение команд:** Командам потребуется обучение практикам контрактного тестирования и работе с новыми инструментами тестирования.